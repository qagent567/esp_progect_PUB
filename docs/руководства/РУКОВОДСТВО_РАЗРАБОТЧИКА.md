# üë®‚Äçüíª AgriSwarm: –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞

*–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ "–ú–æ–¥—É–ª—å–Ω–æ–º—É –ú–æ–Ω–æ–ª–∏—Ç—É —Å –≠–ª–µ–º–µ–Ω—Ç–∞–º–∏ –ú–∏–∫—Ä–æ—è–¥—Ä–∞"*

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ö–æ–¥–æ–≤–æ–π –ë–∞–∑—ã

### üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ü—Ä–æ–µ–∫—Ç–∞
```
esp_progect_0_3_5-1/
‚îú‚îÄ‚îÄ src/                    # –ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ (.cpp —Ñ–∞–π–ª—ã)
‚îÇ   ‚îú‚îÄ‚îÄ main.cpp           # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (664 —Å—Ç—Ä–æ–∫–∏)
‚îÇ   ‚îú‚îÄ‚îÄ CommandExecutor.cpp # –°–∏—Å—Ç–µ–º–∞ –∫–æ–º–∞–Ω–¥ (6286 —Å—Ç—Ä–æ–∫–∏)
‚îÇ   ‚îú‚îÄ‚îÄ PinManager.cpp     # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ GPIO (1635 —Å—Ç—Ä–æ–∫)
‚îÇ   ‚îú‚îÄ‚îÄ NetworkManager.cpp # Mesh-—Å–µ—Ç—å (948 —Å—Ç—Ä–æ–∫)
‚îÇ   ‚îî‚îÄ‚îÄ ...               # –û—Å—Ç–∞–ª—å–Ω—ã–µ 31 –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
‚îú‚îÄ‚îÄ include/                # –ó–∞–≥–æ–ª–æ–≤–æ—á–Ω—ã–µ —Ñ–∞–π–ª—ã (.h)
‚îÇ   ‚îú‚îÄ‚îÄ Constants.h        # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã (114 —Å—Ç—Ä–æ–∫)
‚îÇ   ‚îú‚îÄ‚îÄ Structures.h       # –°—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö (123 —Å—Ç—Ä–æ–∫–∏)
‚îÇ   ‚îú‚îÄ‚îÄ PinManager.h       # API —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è GPIO (161 —Å—Ç—Ä–æ–∫–∞)
‚îÇ   ‚îî‚îÄ‚îÄ ...               # –û—Å—Ç–∞–ª—å–Ω—ã–µ 34 –∑–∞–≥–æ–ª–æ–≤–∫–∞
‚îú‚îÄ‚îÄ platformio.ini         # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–±–æ—Ä–∫–∏
‚îî‚îÄ‚îÄ data/                  # –§–∞–π–ª—ã –¥–ª—è LittleFS (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
```

### üîß –°–∏—Å—Ç–µ–º—ã –°–±–æ—Ä–∫–∏
```ini
# platformio.ini - –æ—Å–Ω–æ–≤–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
[env:wemos_d1_mini32]
platform = espressif32
board = wemos_d1_mini32
framework = arduino
board_build.f_cpu = 240000000L
board_build.filesystem = littlefs
board_build.partitions = huge_app.csv
monitor_speed = 115200

lib_deps =
    bblanchon/ArduinoJson@^6.19.0
    RobTillaart/CRC@^1.0.3
    adafruit/DHT sensor library@^1.4.4
    adafruit/Adafruit Unified Sensor@^1.1.9
    painlessMesh@^1.2.0
```

---

## üß¨ –°–∏—Å—Ç–µ–º–∞ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏

*–ò–∑ main.cpp, —Å—Ç—Ä–æ–∫–∏ 175-280:*

### üîÑ –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ó–∞–ø—É—Å–∫–∞

```cpp
void setup() {
    Serial.begin(SERIAL_BAUD_RATE);                    // 115200
    pinMode(STATUS_LED_PIN, OUTPUT);                   // LED —Å—Ç–∞—Ç—É—Å–∞
    esp_log_set_vprintf(customLogOutput);              // –ö–∞—Å—Ç–æ–º–Ω—ã–µ –ª–æ–≥–∏
    Logger::getInstance().begin(LOG_LEVEL_INFO);       // –°–∏—Å—Ç–µ–º–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
    
#if SAFE_INITIALIZATION
    // –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å watchdog
    configManager.begin();
    SystemMonitor::getInstance().feedWatchdog();
    
    SystemMonitor::getInstance().begin();
    SystemMonitor::getInstance().feedWatchdog();
    
    taskScheduler.begin();
    SystemMonitor::getInstance().feedWatchdog();
    
    pinManager.begin();
    SystemMonitor::getInstance().feedWatchdog();
    
    messageQueueManager.begin();
    SystemMonitor::getInstance().feedWatchdog();
    
    ruleEngine.begin();
    SystemMonitor::getInstance().feedWatchdog();
    
    algorithmScheduler.begin();
    SystemMonitor::getInstance().feedWatchdog();
    
    commandExecutor.begin();
    SystemMonitor::getInstance().feedWatchdog();
    
    networkManager.begin();
    networkManager.setNodeManager(&nodeManager);
    SystemMonitor::getInstance().feedWatchdog();
    
    nodeManager.begin();
    SystemMonitor::getInstance().feedWatchdog();
#endif
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ callback'–æ–≤ –º–µ–∂–¥—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏
    setupCallbacks();
}
```

### üìã –°–∏—Å—Ç–µ–º–∞ Callback'–æ–≤

```cpp
// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –º–µ–∂–¥—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏
void setupCallbacks() {
    // MessageQueue ‚Üí NetworkManager
    messageQueueManager.setSendCallback([&](uint32_t nodeId, const String& message) -> bool {
        StaticJsonDocument<1024> doc;
        DeserializationError error = deserializeJson(doc, message);
        if (error) return false;
        return networkManager.sendMessage(nodeId, doc);
    });
    
    // RuleEngine ‚Üí PinManager  
    ruleEngine.setActionCallback([&](const RuleAction& action) -> bool {
        switch (action.type) {
            case ACTION_SET_PIN_STATE:
                bool state = (action.payload == "on");
                return pinManager.setPinState(action.target, state);
        }
    });
    
    // InteractiveHelper ‚Üí CommandExecutor
    InteractiveHelper::getInstance().setCommandCallback([&](const String& command) -> bool {
        return commandExecutor.executeCommand(command);
    });
}
```

---

## üåê Mesh-–°–µ—Ç—å: –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

*–ò–∑ NetworkManager.cpp –∏ Constants.h:*

### ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è painlessMesh

```cpp
// Constants.h - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ç–∏
#define MESH_PREFIX "AgriSwarmMesh"
#define MESH_PASSWORD "AgriSwarmMeshPassword"
#define MESH_PORT 5555
#define MESH_CHANNEL 6                     // WiFi –∫–∞–Ω–∞–ª 2.4GHz
#define MESH_MAX_CONNECTIONS 20            // –ú–∞–∫—Å–∏–º—É–º —É–∑–ª–æ–≤
#define MESH_HEARTBEAT_INTERVAL 5000       // Heartbeat –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫
#define MESH_NODE_TIMEOUT 8000             // –¢–∞–π–º–∞—É—Ç —É–∑–ª–∞ 8 —Å–µ–∫
#define WIFI_TX_POWER WIFI_POWER_19_5dBm   // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –º–æ—â–Ω–æ—Å—Ç—å
```

### üì° –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –°–µ—Ç–∏

```cpp
void MeshNetworkManager::begin() {
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ WiFi
    WiFi.mode(WIFI_STA);
    WiFi.setSleep(false);                  // –û—Ç–∫–ª—é—á–∏—Ç—å —ç–Ω–µ—Ä–≥–æ—Å–±–µ—Ä–µ–∂–µ–Ω–∏–µ
    WiFi.enableLongRange(true);            // –£–≤–µ–ª–∏—á–∏—Ç—å –¥–∞–ª—å–Ω–æ—Å—Ç—å
    WiFi.setTxPower((wifi_power_t)WIFI_TX_POWER);
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è painlessMesh
    _mesh.init(MESH_PREFIX, MESH_PASSWORD, MESH_PORT, WIFI_AP_STA, MESH_CHANNEL);
    _mesh.setRoot(true);
    _mesh.setContainsRoot(true);
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
    _mesh.onReceive([this](uint32_t from, String& msg) {
        this->_onReceive(from, msg);
    });
    
    _mesh.onNewConnection([this](uint32_t nodeId) {
        this->_onNewConnection(nodeId);
    });
    
    _mesh.onDroppedConnection([this](uint32_t nodeId) {
        this->_onDroppedConnection(nodeId);
    });
}
```

### üì® –ü—Ä–æ—Ç–æ–∫–æ–ª –°–æ–æ–±—â–µ–Ω–∏–π

```cpp
// –ë–∞–∑–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
{
    "type": "sensor_data|actuator_cmd|heartbeat|ping|pong|node_info",
    "from": 3456789123,
    "to": 2345678912,
    "timestamp": 1635789123,
    "data": { ... }
}

// –ü—Ä–∏–º–µ—Ä: –¥–∞–Ω–Ω—ã–µ –¥–∞—Ç—á–∏–∫–∞
{
    "type": "sensor_data",
    "from": 3456789123,
    "sensor_id": "temp1", 
    "topic": "greenhouse/temperature",
    "value": 24.5,
    "unit": "¬∞C",
    "timestamp": 1635789123
}

// –ü—Ä–∏–º–µ—Ä: –∫–æ–º–∞–Ω–¥–∞ –∞–∫—Ç—É–∞—Ç–æ—Ä—É
{
    "type": "actuator_cmd",
    "from": 3456789123,
    "to": 2345678912,
    "actuator_id": "pump1",
    "command": "on",
    "duration": 5000,
    "command_id": 12345
}
```

---

## üîå –°–∏—Å—Ç–µ–º–∞ –£–ø—Ä–∞–≤–ª–µ–Ω–∏—è GPIO

*–ò–∑ PinManager.h –∏ PinManager.cpp:*

### üìä –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –¢–∏–ø—ã –£—Å—Ç—Ä–æ–π—Å—Ç–≤

```cpp
// Structures.h - –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–æ–≤
enum PinType {
    PIN_TYPE_UNKNOWN = 0,
    PIN_TYPE_DHT11 = 1,        // –î–∞—Ç—á–∏–∫ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã DHT11
    PIN_TYPE_DHT22 = 2,        // –î–∞—Ç—á–∏–∫ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã DHT22
    PIN_TYPE_RELAY = 3,        // –†–µ–ª–µ
    PIN_TYPE_DIGITAL_OUT = 4,  // –¶–∏—Ñ—Ä–æ–≤–æ–π –≤—ã—Ö–æ–¥
    PIN_TYPE_DIGITAL_IN = 5,   // –¶–∏—Ñ—Ä–æ–≤–æ–π –≤—Ö–æ–¥
    PIN_TYPE_ANALOG_IN = 6,    // –ê–Ω–∞–ª–æ–≥–æ–≤—ã–π –≤—Ö–æ–¥
    PIN_TYPE_DHT11_HUM = 7,    // –í–ª–∞–∂–Ω–æ—Å—Ç—å DHT11 (–≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π)
    PIN_TYPE_DHT22_HUM = 8     // –í–ª–∞–∂–Ω–æ—Å—Ç—å DHT22 (–≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π)
};
```

### ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ü–∏–Ω–∞

```cpp
// Structures.h - —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
struct PinConfig {
    String name;                           // –£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è
    uint8_t gpio;                         // GPIO –Ω–æ–º–µ—Ä (0-39)
    PinType type;                         // –¢–∏–ø —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
    String topic;                         // –¢–æ–ø–∏–∫ –¥–ª—è mesh
    float thresholdLow;                   // –ù–∏–∂–Ω–∏–π –ø–æ—Ä–æ–≥
    float thresholdHigh;                  // –í–µ—Ä—Ö–Ω–∏–π –ø–æ—Ä–æ–≥
    bool initialState;                    // –ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    unsigned long interval;               // –ò–Ω—Ç–µ—Ä–≤–∞–ª –æ–ø—Ä–æ—Å–∞ (–º—Å)
    uint8_t logLevel;                     // –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
    uint8_t powerPin = 255;              // GPIO –ø–∏—Ç–∞–Ω–∏—è (255 = –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
    unsigned long powerStabilizeMs = 100; // –í—Ä–µ–º—è —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ –ø–∏—Ç–∞–Ω–∏—è
    uint8_t buttonMode = 0;              // –†–µ–∂–∏–º –∫–Ω–æ–ø–∫–∏ (toggle/momentary)
    unsigned long debounceMs = 50;       // –ê–Ω—Ç–∏–¥—Ä–µ–±–µ–∑–≥ (–º—Å)
    unsigned long maxHoldMs = 5000;      // –ú–∞–∫—Å –≤—Ä–µ–º—è —É–¥–µ—Ä–∂–∞–Ω–∏—è
};
```

### üîß API –£–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ü–∏–Ω–∞–º–∏

```cpp
class PinManager {
public:
    // –û—Å–Ω–æ–≤–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
    bool setupPin(const PinConfig& config);
    bool deletePin(const String& pinName);
    bool setPinState(const String& pinName, bool state);
    float getPinValue(const String& pinName);
    
    // –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
    void updateSensors();                 // –û–ø—Ä–æ—Å –≤—Å–µ—Ö –¥–∞—Ç—á–∏–∫–æ–≤
    SensorData getLastSensorData(const String& sensorId);
    
    // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    PinConfig getPinConfig(const String& pinName) const;
    std::vector<PinConfig> getAllPinConfigs() const;
    std::vector<String> getAllAvailablePins();
    
private:
    // –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –º–µ—Ç–æ–¥—ã
    bool _setupDhtSensor(const PinConfig& config);
    bool _setupRelay(const PinConfig& config);
    bool _setupAnalogIn(const PinConfig& config);
    bool _setupDigitalIn(const PinConfig& config);
    
    SensorData _readDhtData(const PinConfig& config);
    SensorData _readAnalogSensorData(const PinConfig& config);
    SensorData _readDigitalInState(const PinConfig& config);
};
```

### üå°Ô∏è –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –†–∞–±–æ—Ç—ã —Å DHT

```cpp
// PinManager.cpp - –æ–±—Ä–∞–±–æ—Ç–∫–∞ DHT –¥–∞—Ç—á–∏–∫–æ–≤
SensorData PinManager::_readDhtData(const PinConfig& config) {
    SensorData data;
    data.timestamp = millis();
    
    DHT* dhtSensor = _dhtSensors[config.name];
    if (!dhtSensor) return data;
    
    // DHT —Ç—Ä–µ–±—É–µ—Ç –º–∏–Ω–∏–º—É–º 2 —Å–µ–∫—É–Ω–¥—ã –º–µ–∂–¥—É —á—Ç–µ–Ω–∏—è–º–∏
    unsigned long lastRead = _lastSensorAttempt[config.name];
    if (millis() - lastRead < 2000) {
        return _lastSensorData[config.name]; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    }
    
    float value;
    if (config.type == PIN_TYPE_DHT11 || config.type == PIN_TYPE_DHT22) {
        value = dhtSensor->readTemperature();
        data.type = SENSOR_DATA_TEMPERATURE;
    } else {
        value = dhtSensor->readHumidity();
        data.type = SENSOR_DATA_HUMIDITY;
    }
    
    if (isnan(value)) {
        // –°–∏—Å—Ç–µ–º–∞ backoff –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö DHT
        _dhtBackoffMs[config.name] = min(_dhtBackoffMs[config.name] * 2, 30000UL);
        return _lastSensorData[config.name];
    }
    
    _dhtBackoffMs[config.name] = 0; // –°–±—Ä–æ—Å backoff –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º —á—Ç–µ–Ω–∏–∏
    data.value = value;
    _lastSensorData[config.name] = data;
    return data;
}
```

---

## ü§ñ –°–∏—Å—Ç–µ–º–∞ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏

*–ò–∑ RuleEngine.h –∏ RuleEngine.cpp:*

### üìù –°—Ç—Ä—É–∫—Ç—É—Ä—ã –ü—Ä–∞–≤–∏–ª

```cpp
// –£—Å–ª–æ–≤–∏–µ –ø—Ä–∞–≤–∏–ª–∞
struct RuleCondition {
    RuleConditionType type;    // >, <, ==, !=, BETWEEN, CHANGED
    String source;             // –ò–º—è –¥–∞—Ç—á–∏–∫–∞ –∏–ª–∏ —Ç–æ–ø–∏–∫
    float value;               // –ó–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
    float value2;              // –í—Ç–æ—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (–¥–ª—è BETWEEN)
    bool enabled;              // –í–∫–ª—é—á–µ–Ω–æ –ª–∏ —É—Å–ª–æ–≤–∏–µ
};

// –î–µ–π—Å—Ç–≤–∏–µ –ø—Ä–∞–≤–∏–ª–∞
struct RuleAction {
    RuleActionType type;       // SET_PIN_STATE, SEND_MESSAGE, LOG, TRIGGER_TASK
    String target;             // –¶–µ–ª–µ–≤–æ–π –ø–∏–Ω/—É–∑–µ–ª/–∑–∞–¥–∞—á–∞
    String payload;            // –î–∞–Ω–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
    bool enabled;              // –í–∫–ª—é—á–µ–Ω–æ –ª–∏ –¥–µ–π—Å—Ç–≤–∏–µ
};

// –ü–æ–ª–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ
struct AutomationRule {
    String id;                 // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID
    String name;               // –ß–∏—Ç–∞–µ–º–æ–µ –∏–º—è
    String description;        // –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞
    RuleCondition condition;   // –£—Å–ª–æ–≤–∏–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è
    RuleAction action;         // –í—ã–ø–æ–ª–Ω—è–µ–º–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ
    bool enabled;              // –í–∫–ª—é—á–µ–Ω–æ/–≤—ã–∫–ª—é—á–µ–Ω–æ
    unsigned long lastTriggered;    // –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è
    unsigned long cooldownPeriod;   // –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è–º–∏
    uint32_t triggerCount;          // –°—á–µ—Ç—á–∏–∫ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π
};
```

### üîÑ –¶–∏–∫–ª –û–±—Ä–∞–±–æ—Ç–∫–∏ –ü—Ä–∞–≤–∏–ª

```cpp
void RuleEngine::update() {
    unsigned long now = millis();
    
    for (auto& rule : _rules) {
        if (!rule.enabled) continue;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—É–ª–¥–∞—É–Ω
        if (now - rule.lastTriggered < rule.cooldownPeriod) continue;
        
        // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–∞—Ç—á–∏–∫–∞
        float currentValue = _getSensorValue(rule.condition.source);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏–µ
        bool conditionMet = false;
        switch (rule.condition.type) {
            case CONDITION_GREATER_THAN:
                conditionMet = (currentValue > rule.condition.value);
                break;
            case CONDITION_LESS_THAN:
                conditionMet = (currentValue < rule.condition.value);
                break;
            case CONDITION_EQUALS:
                conditionMet = (abs(currentValue - rule.condition.value) < 0.01f);
                break;
            // ... –¥—Ä—É–≥–∏–µ —É—Å–ª–æ–≤–∏—è
        }
        
        if (conditionMet) {
            executeAction(rule.action);
            rule.lastTriggered = now;
            rule.triggerCount++;
            
            Logger::getInstance().info("RuleEngine", 
                "–ü—Ä–∞–≤–∏–ª–æ '%s' —Å—Ä–∞–±–æ—Ç–∞–ª–æ. –ó–Ω–∞—á–µ–Ω–∏–µ: %.2f", 
                rule.id.c_str(), currentValue);
        }
    }
}
```

---

## üíæ –°–∏—Å—Ç–µ–º–∞ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

*–ò–∑ ConfigManager.cpp:*

### üìÅ –§–∞–π–ª–æ–≤–∞—è –°–∏—Å—Ç–µ–º–∞

```cpp
// –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∞–π–ª—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
#define CONFIG_FILE "/config.json"
#define CONFIG_BACKUP_FILE "/config_backup.json"
#define WIFI_CONFIG_FILE "/wifi_config.json"
#define NODE_NAME_FILE "/node_name.json"
#define NODE_ACCESS_FILE "/node_access.json"
#define PIN_CONFIG_DIR "/pins"
#define RULES_FILE "/rules.json"
#define TASKS_FILE "/tasks.json"

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è LittleFS
void ConfigManager::begin() {
    if (!LittleFS.begin()) {
        Logger::getInstance().error("ConfigManager", "–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ LittleFS");
        return;
    }
    
    // –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
    if (!LittleFS.exists(PIN_CONFIG_DIR)) {
        LittleFS.mkdir(PIN_CONFIG_DIR);
    }
    
    loadConfig();
}
```

### üîß API –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

```cpp
class ConfigManager {
public:
    // –û—Å–Ω–æ–≤–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
    bool loadConfig();
    bool saveConfig();
    bool createBackup();
    bool restoreFromBackup();
    
    // –†–∞–±–æ—Ç–∞ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
    String getConfigValue(const String& key);
    bool setConfigValue(const String& key, const String& value);
    
    // –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    WifiConfig loadWifiConfig();
    bool saveWifiConfig(const WifiConfig& config);
    
    bool savePinConfig(const PinConfig& config);
    std::vector<PinConfig> loadAllPinConfigs();
    
private:
    JsonDocument _config;
    String _configFilePath;
    uint32_t _lastConfigCRC;
    
    uint32_t _calculateCRC(const String& data);
    bool _validateConfig(const JsonDocument& doc);
};
```

### üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –î–∞–Ω–Ω—ã—Ö

```cpp
bool ConfigManager::saveConfig() {
    // –°–æ–∑–¥–∞–Ω–∏–µ JSON
    String configData;
    serializeJson(_config, configData);
    
    // –í—ã—á–∏—Å–ª–µ–Ω–∏–µ CRC –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏
    uint32_t crc = _calculateCRC(configData);
    _config["system"]["config_crc"] = crc;
    
    // –°–æ–∑–¥–∞–Ω–∏–µ backup –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
    if (LittleFS.exists(CONFIG_FILE)) {
        LittleFS.rename(CONFIG_FILE, CONFIG_BACKUP_FILE);
    }
    
    // –ê—Ç–æ–º–∞—Ä–Ω–∞—è –∑–∞–ø–∏—Å—å —á–µ—Ä–µ–∑ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
    File tempFile = LittleFS.open(CONFIG_FILE + ".tmp", "w");
    if (!tempFile) return false;
    
    size_t written = tempFile.print(configData);
    tempFile.close();
    
    if (written != configData.length()) {
        LittleFS.remove(CONFIG_FILE + ".tmp");
        return false;
    }
    
    // –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –≤ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª
    LittleFS.rename(CONFIG_FILE + ".tmp", CONFIG_FILE);
    return true;
}
```

---

## üîê –°–∏—Å—Ç–µ–º–∞ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

*–ò–∑ SafeMemory.h, SafeMath.h, SystemMonitor.cpp:*

### üõ°Ô∏è SafeMemory - –ó–∞—â–∏—Ç–∞ –ü–∞–º—è—Ç–∏

```cpp
// SafeMemory.h - –º–∞–∫—Ä–æ—Å—ã –∑–∞—â–∏—Ç—ã
#define SAFE_MALLOC(size) safeMalloc(size, __FILE__, __LINE__)
#define SAFE_FREE(ptr) safeFree(ptr, __FILE__, __LINE__)
#define SAFE_STRNCPY(dest, src, size) safeStrncpy(dest, src, size)

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥—Ä–∞–Ω–∏—Ü –±—É—Ñ–µ—Ä–∞
template<size_t N>
bool safeBufferWrite(char (&buffer)[N], size_t pos, const char* data, size_t dataLen) {
    if (pos >= N || pos + dataLen >= N) {
        Logger::getInstance().error("SafeMemory", "–ü–æ–ø—ã—Ç–∫–∞ –∑–∞–ø–∏—Å–∏ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã –±—É—Ñ–µ—Ä–∞");
        return false;
    }
    strncpy(&buffer[pos], data, dataLen);
    buffer[pos + dataLen] = '\0';
    return true;
}

// –ö–æ–Ω—Ç—Ä–æ–ª—å —É—Ç–µ—á–µ–∫ –ø–∞–º—è—Ç–∏
void* safeMalloc(size_t size, const char* file, int line) {
    void* ptr = malloc(size);
    if (ptr) {
        _allocatedBlocks[ptr] = {size, file, line, millis()};
        _totalAllocated += size;
    }
    return ptr;
}
```

### üßÆ SafeMath - –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞

```cpp
// SafeMath.h - –∑–∞—â–∏—Ç–∞ –æ—Ç –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫
bool safeDivide(float a, float b, float& result) {
    if (abs(b) < 1e-10f) {
        Logger::getInstance().warn("SafeMath", "–ü–æ–ø—ã—Ç–∫–∞ –¥–µ–ª–µ–Ω–∏—è –Ω–∞ –Ω–æ–ª—å: %.6f / %.6f", a, b);
        return false;
    }
    result = a / b;
    return true;
}

bool safeMultiply(float a, float b, float& result) {
    if (abs(a) > 1e20f || abs(b) > 1e20f) {
        Logger::getInstance().warn("SafeMath", "–†–∏—Å–∫ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–∏ —É–º–Ω–æ–∂–µ–Ω–∏–∏");
        return false;
    }
    result = a * b;
    return !isnan(result) && isfinite(result);
}

bool validateFloatRange(float value, float min, float max) {
    return !isnan(value) && isfinite(value) && value >= min && value <= max;
}
```

### ‚è∞ SystemMonitor - Watchdog

```cpp
// SystemMonitor.cpp - –∫–æ–Ω—Ç—Ä–æ–ª—å —Å–∏—Å—Ç–µ–º—ã
void SystemMonitor::begin() {
    _startTime = millis();
    _lastWatchdogFeed = millis();
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–ø–ø–∞—Ä–∞—Ç–Ω–æ–≥–æ watchdog ESP32
    esp_task_wdt_init(30, true); // 30 —Å–µ–∫—É–Ω–¥ —Ç–∞–π–º–∞—É—Ç
    esp_task_wdt_add(NULL);      // –î–æ–±–∞–≤–∏—Ç—å —Ç–µ–∫—É—â—É—é –∑–∞–¥–∞—á—É
    
    _isInitialized = true;
}

void SystemMonitor::feedWatchdog() {
    if (!_isInitialized) return;
    
    esp_task_wdt_reset();
    _lastWatchdogFeed = millis();
    _watchdogFeedCount++;
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ä–µ—Å—É—Ä—Å–æ–≤
    checkCriticalResources();
}

void SystemMonitor::checkCriticalResources() {
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤–æ–±–æ–¥–Ω–æ–π –ø–∞–º—è—Ç–∏
    size_t freeHeap = ESP.getFreeHeap();
    if (freeHeap < 10000) { // –ú–µ–Ω–µ–µ 10KB
        Logger::getInstance().error("SystemMonitor", 
            "–ö–†–ò–¢–ò–ß–ï–°–ö–ò –ú–ê–õ–û –ü–ê–ú–Ø–¢–ò: %d –±–∞–π—Ç", freeHeap);
        // –ê–≤–∞—Ä–∏–π–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –±—É—Ñ–µ—Ä–æ–≤
        emergencyCleanup();
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –±–µ–∑ watchdog
    if (millis() - _lastWatchdogFeed > 25000) { // 25 —Å–µ–∫—É–Ω–¥
        Logger::getInstance().error("SystemMonitor", 
            "–î–û–õ–ì–û–ï –í–†–ï–ú–Ø –ë–ï–ó WATCHDOG: %lu –º—Å", millis() - _lastWatchdogFeed);
    }
}
```

---

## üöÄ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ù–æ–≤–æ–≥–æ –¢–∏–ø–∞ –î–∞—Ç—á–∏–∫–∞

### 1Ô∏è‚É£ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ Structures.h

```cpp
// Structures.h - –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ç–∏–ø
enum PinType {
    // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–∏–ø—ã ...
    PIN_TYPE_CUSTOM_SENSOR = 10,    // –í–∞—à –Ω–æ–≤—ã–π —Ç–∏–ø
};
```

### 2Ô∏è‚É£ –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ PinManager

```cpp
// PinManager.cpp - –¥–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –Ω–æ–≤–æ–≥–æ —Ç–∏–ø–∞
bool PinManager::_setupCustomSensor(const PinConfig& config) {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∞—à–µ–≥–æ –¥–∞—Ç—á–∏–∫–∞
    pinMode(config.gpio, INPUT);
    
    // –°–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
    // ... –≤–∞—à –∫–æ–¥ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ ...
    
    Logger::getInstance().info("PinManager", 
        "–ù–∞—Å—Ç—Ä–æ–µ–Ω –∫–∞—Å—Ç–æ–º–Ω—ã–π –¥–∞—Ç—á–∏–∫ '%s' –Ω–∞ GPIO %d", 
        config.name.c_str(), config.gpio);
    return true;
}

SensorData PinManager::_readCustomSensorData(const PinConfig& config) {
    SensorData data;
    data.timestamp = millis();
    data.type = SENSOR_DATA_ANALOG; // –∏–ª–∏ –≤–∞—à —Ç–∏–ø
    
    // –ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å –¥–∞—Ç—á–∏–∫–∞
    data.value = readYourSensor(config.gpio);
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
    if (!validateSensorReading(data.value)) {
        data.value = NAN;
    }
    
    return data;
}

// –î–æ–±–∞–≤–∏—Ç—å –≤ switch –±–ª–æ–∫–∏
bool PinManager::setupPin(const PinConfig& config) {
    switch (config.type) {
        // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–∏–ø—ã ...
        case PIN_TYPE_CUSTOM_SENSOR:
            result = _setupCustomSensor(config);
            break;
    }
}

void PinManager::updateSensors() {
    // –í —Ü–∏–∫–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞—Ç—á–∏–∫–æ–≤
    switch (config.type) {
        // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–∏–ø—ã ...
        case PIN_TYPE_CUSTOM_SENSOR:
            data = _readCustomSensorData(config);
            break;
    }
}
```

### 3Ô∏è‚É£ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ CommandExecutor

```cpp
// CommandExecutor.cpp - –¥–æ–±–∞–≤–∏—Ç—å –≤ —Å–ø—Ä–∞–≤–∫—É –∏ –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ
void CommandExecutor::_showPinSetupHelp() {
    Serial.println("üå°Ô∏è –¢–ò–ü–´ –î–ê–¢–ß–ò–ö–û–í:");
    Serial.println("  DHT11       - –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞/–≤–ª–∞–∂–Ω–æ—Å—Ç—å (¬±2¬∞C, ¬±5%)");
    Serial.println("  DHT22       - –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞/–≤–ª–∞–∂–Ω–æ—Å—Ç—å (¬±0.5¬∞C, ¬±2%)");
    // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–∏–ø—ã ...
    Serial.println("  CUSTOM_SENSOR - –í–∞—à –∫–∞—Å—Ç–æ–º–Ω—ã–π –¥–∞—Ç—á–∏–∫");
}
```

---

## üîß –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ù–æ–≤–æ–π –ö–æ–º–∞–Ω–¥—ã

### 1Ô∏è‚É£ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ö–æ–º–∞–Ω–¥—ã

```cpp
// CommandExecutor.cpp - –≤ –º–µ—Ç–æ–¥–µ _registerCommands()
void CommandExecutor::_registerCommands() {
    // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–º–∞–Ω–¥—ã ...
    
    _commands.push_back({
        "my_command",                    // –ò–º—è –∫–æ–º–∞–Ω–¥—ã
        "–û–ø–∏—Å–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã",              // –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
        "my_command <–ø–∞—Ä–∞–º–µ—Ç—Ä>",         // –°–∏–Ω—Ç–∞–∫—Å–∏—Å
        "custom"                         // –ö–∞—Ç–µ–≥–æ—Ä–∏—è
    });
}
```

### 2Ô∏è‚É£ –û–±—Ä–∞–±–æ—Ç–∫–∞ –ö–æ–º–∞–Ω–¥—ã

```cpp
// CommandExecutor.cpp - –≤ –º–µ—Ç–æ–¥–µ executeCommand()
bool CommandExecutor::executeCommand(const String& input) {
    String cmd = input.substring(0, spaceIndex);
    String args = input.substring(spaceIndex + 1);
    
    // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–º–∞–Ω–¥—ã ...
    
    if (cmd.equalsIgnoreCase("my_command")) {
        return _executeMyCommand(args);
    }
    
    return false;
}

bool CommandExecutor::_executeMyCommand(const String& args) {
    if (args.isEmpty()) {
        Serial.println("‚ùå –û—à–∏–±–∫–∞: —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–∞—Ä–∞–º–µ—Ç—Ä");
        Serial.println("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: my_command <–ø–∞—Ä–∞–º–µ—Ç—Ä>");
        return false;
    }
    
    // –í–∞—à–∞ –ª–æ–≥–∏–∫–∞ –∫–æ–º–∞–Ω–¥—ã
    Serial.println("‚úÖ –ö–æ–º–∞–Ω–¥–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º: " + args);
    
    // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
    Logger::getInstance().info("CommandExecutor", 
        "–í—ã–ø–æ–ª–Ω–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ my_command —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º: %s", args.c_str());
    
    return true;
}
```

---

## üìä –°–∏—Å—Ç–µ–º–∞ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

### üîç –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏—Ö –ü—Ä–æ–≤–µ—Ä–æ–∫

```cpp
// SystemDiagnostics.cpp - –ø—Ä–∏–º–µ—Ä –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
DiagnosticResult SystemDiagnostics::checkCustomComponent() {
    DiagnosticResult result;
    result.componentName = "CustomComponent";
    result.timestamp = millis();
    
    // –í–∞—à–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏
    if (customComponentStatus == OK) {
        result.status = DIAGNOSTIC_OK;
        result.message = "–ö–æ–º–ø–æ–Ω–µ–Ω—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ";
        result.severity = SEVERITY_INFO;
    } else {
        result.status = DIAGNOSTIC_WARNING;
        result.message = "–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã —Å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–º";
        result.severity = SEVERITY_WARNING;
    }
    
    return result;
}

// –î–æ–±–∞–≤–∏—Ç—å –≤ –æ–±—â—É—é –ø—Ä–æ–≤–µ—Ä–∫—É
std::vector<DiagnosticResult> SystemDiagnostics::runFullDiagnostics() {
    std::vector<DiagnosticResult> results;
    
    // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ ...
    results.push_back(checkCustomComponent());
    
    return results;
}
```

---

## üåê –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ Mesh-–ü—Ä–æ—Ç–æ–∫–æ–ª–∞

### üì® –ù–æ–≤—ã–π –¢–∏–ø –°–æ–æ–±—â–µ–Ω–∏—è

```cpp
// MessageRouter.cpp - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞
void MessageRouter::begin() {
    // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ ...
    
    registerHandler("custom_message", [this](uint32_t from, const JsonDocument& doc) {
        this->_handleCustomMessage(from, doc);
    }, "–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π");
}

void MessageRouter::_handleCustomMessage(uint32_t from, const JsonDocument& doc) {
    String customData = doc["custom_data"];
    
    Logger::getInstance().info("MessageRouter", 
        "–ü–æ–ª—É—á–µ–Ω–æ –∫–∞—Å—Ç–æ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç —É–∑–ª–∞ %u: %s", from, customData.c_str());
    
    // –í–∞—à–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    processCustomData(customData);
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
bool NetworkManager::sendCustomMessage(uint32_t nodeId, const String& data) {
    StaticJsonDocument<512> doc;
    doc["type"] = "custom_message";
    doc["from"] = getMeshNodeId();
    doc["custom_data"] = data;
    doc["timestamp"] = millis();
    
    return sendMessage(nodeId, doc);
}
```

---

## üöÄ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### üíæ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ü–∞–º—è—Ç—å—é

```cpp
// –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è JSON
void optimizedJsonProcessing() {
    // –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –±—É—Ñ–µ—Ä—ã —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
    StaticJsonDocument<1024> doc;  // –í–º–µ—Å—Ç–æ DynamicJsonDocument
    
    // –û—á–∏—â–∞–π—Ç–µ –±—É—Ñ–µ—Ä—ã –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
    doc.clear();
    
    // –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–π—Ç–µ —Ä–∞–∑–º–µ—Ä JSON –¥–∞–Ω–Ω—ã—Ö
    if (measureJson(doc) > 800) {  // –û—Å—Ç–∞–≤–ª—è–µ–º –∑–∞–ø–∞—Å
        Logger::getInstance().warn("JSON", "–†–∞–∑–º–µ—Ä JSON –±–ª–∏–∑–æ–∫ –∫ –ª–∏–º–∏—Ç—É –±—É—Ñ–µ—Ä–∞");
    }
}

// –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–æ–∫
void optimizedStringHandling() {
    // –ò–∑–±–µ–≥–∞–π—Ç–µ —á–∞—Å—Ç—ã—Ö –∫–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏–π String
    String result;
    result.reserve(256);  // –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –≤—ã–¥–µ–ª–∏—Ç—å –ø–∞–º—è—Ç—å
    
    // –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ StringBuilder –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∫–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏–π
    result += "Part 1";
    result += "Part 2";
    
    // –ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–π—Ç–µ const char* –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Å—Ç—Ä–æ–∫
    const char* STATIC_MESSAGE = "–°—Ç–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ";
}
```

### ‚ö° –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¶–∏–∫–ª–æ–≤

```cpp
// –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –≥–ª–∞–≤–Ω–æ–≥–æ —Ü–∏–∫–ª–∞
void loop() {
    unsigned long loopStart = micros();
    
    // –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (–∫–∞–∂–¥—ã–π —Ü–∏–∫–ª)
    networkManager.handleClient();          // < 1–º—Å
    SystemMonitor::getInstance().feedWatchdog();
    
    // –ú–µ–Ω–µ–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (—Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞–º–∏)
    static unsigned long lastSensorUpdate = 0;
    if (millis() - lastSensorUpdate > 100) {  // –ö–∞–∂–¥—ã–µ 100–º—Å
        pinManager.updateSensors();
        lastSensorUpdate = millis();
    }
    
    static unsigned long lastRulesCheck = 0;
    if (millis() - lastRulesCheck > 1000) {  // –ö–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
        ruleEngine.update();
        lastRulesCheck = millis();
    }
    
    // –ò–∑–º–µ—Ä–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    unsigned long loopTime = micros() - loopStart;
    if (loopTime > 10000) {  // > 10–º—Å
        Logger::getInstance().warn("Performance", "–ú–µ–¥–ª–µ–Ω–Ω—ã–π —Ü–∏–∫–ª: %lu –º–∫—Å", loopTime);
    }
}
```

---

## üìã –°—Ç–∞–Ω–¥–∞—Ä—Ç—ã –ö–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è

### üìù –ü—Ä–∞–≤–∏–ª–∞ –ù–∞–ø–∏—Å–∞–Ω–∏—è –ö–æ–¥–∞

```cpp
// –ò–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏ —Ñ—É–Ω–∫—Ü–∏–π
class MyComponent {
private:
    int _privateVariable;        // –ü–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ –¥–ª—è private
    static const int MAX_SIZE;   // CAPS –¥–ª—è –∫–æ–Ω—Å—Ç–∞–Ω—Ç
    
public:
    void publicMethod();         // camelCase –¥–ª—è –º–µ—Ç–æ–¥–æ–≤
    bool isComponentReady();     // –ë—É–ª–µ–≤—ã –º–µ—Ç–æ–¥—ã –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å is/has/can
    
    // –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —Å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π
    MyComponent(ConfigManager& config) 
        : _configManager(config), _isInitialized(false) {}
};

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
bool MyComponent::initialize() {
    if (_isInitialized) {
        Logger::getInstance().warn("MyComponent", "–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è");
        return true;
    }
    
    if (!_configManager.isReady()) {
        Logger::getInstance().error("MyComponent", "ConfigManager –Ω–µ –≥–æ—Ç–æ–≤");
        return false;
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –æ—à–∏–±–æ–∫
    if (!performInitialization()) {
        Logger::getInstance().error("MyComponent", "–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏");
        return false;
    }
    
    _isInitialized = true;
    Logger::getInstance().info("MyComponent", "–£—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω");
    return true;
}
```

### üìö –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ö–æ–¥–∞

```cpp
/**
 * @brief –£–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∏ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –¥–∞—Ç—á–∏–∫–æ–≤ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã DHT
 * 
 * –ö–ª–∞—Å—Å –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:
 * - –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é DHT11/DHT22 –¥–∞—Ç—á–∏–∫–æ–≤
 * - –ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –æ—à–∏–±–æ–∫
 * - –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
 * - –°–∏—Å—Ç–µ–º—É backoff –ø—Ä–∏ –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç–µ –¥–∞—Ç—á–∏–∫–∞
 * 
 * @note DHT –¥–∞—Ç—á–∏–∫–∏ —Ç—Ä–µ–±—É—é—Ç –º–∏–Ω–∏–º—É–º 2 —Å–µ–∫—É–Ω–¥—ã –º–µ–∂–¥—É —á—Ç–µ–Ω–∏—è–º–∏
 * @warning –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–æ–ª–µ–µ 10 DHT –¥–∞—Ç—á–∏–∫–æ–≤ –Ω–∞ –æ–¥–∏–Ω ESP32
 */
class DhtManager {
public:
    /**
     * @brief –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç DHT –¥–∞—Ç—á–∏–∫ –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω–æ–º GPIO
     * 
     * @param gpio GPIO –ø–∏–Ω (2-39, –∏—Å–∫–ª—é—á–∞—è 6-11)
     * @param type –¢–∏–ø –¥–∞—Ç—á–∏–∫–∞ (DHT11 –∏–ª–∏ DHT22)
     * @return true –µ—Å–ª–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞
     * @return false –ø—Ä–∏ –æ—à–∏–±–∫–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
     * 
     * @example
     * ```cpp
     * DhtManager dht;
     * if (dht.initialize(4, DHT22)) {
     *     float temp = dht.readTemperature();
     * }
     * ```
     */
    bool initialize(uint8_t gpio, DhtType type);
    
private:
    std::map<uint8_t, DHT*> _sensors;  ///< –ö–∞—Ä—Ç–∞ GPIO -> DHT –æ–±—ä–µ–∫—Ç
    unsigned long _lastRead = 0;        ///< –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —á—Ç–µ–Ω–∏—è
    static const int MIN_INTERVAL = 2000; ///< –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É —á—Ç–µ–Ω–∏—è–º–∏ (–º—Å)
};
```

---

## üéØ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

### ‚úÖ –°–∏–ª—å–Ω—ã–µ –°—Ç–æ—Ä–æ–Ω—ã –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

1. **üîÑ –ú–æ–¥—É–ª—å–Ω–æ—Å—Ç—å** - 35 –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Å —á—ë—Ç–∫–∏–º API
2. **üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - Watchdog, –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–∞–º—è—Ç–∏, SafeMath
3. **üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - –ü–æ–¥—Ä–æ–±–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
4. **üîß –†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å** - –ü—Ä–æ—Å—Ç–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –¥–∞—Ç—á–∏–∫–æ–≤ –∏ –∫–æ–º–∞–Ω–¥
5. **‚ö° –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ü–∏–∫–ª—ã –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é

### üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –†–∞–∑–≤–∏—Ç–∏—é

1. **üì± –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å** - –°–æ–∑–¥–∞—Ç—å HTTP —Å–µ—Ä–≤–µ—Ä –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä
2. **üíæ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö** - –î–æ–±–∞–≤–∏—Ç—å SQLite –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
3. **üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –∏ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ
4. **üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞** - –°–∏—Å—Ç–µ–º–∞ —Ç—Ä–µ–Ω–¥–æ–≤ –∏ –ø—Ä–µ–¥–∏–∫—Ç–∏–≤–Ω–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
5. **üåç –û–±–ª–∞–∫–æ** - –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –æ–±–ª–∞—á–Ω—ã–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏

### üîß –†–µ–∞–ª–∏—Å—Ç–∏—á–Ω–∞—è –û—Ü–µ–Ω–∫–∞ –û—Å–Ω–æ–≤—ã

AgriSwarm –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç **—ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω—É—é —Ç–µ—Ö–Ω–∏—á–µ—Å–∫—É—é –æ—Å–Ω–æ–≤—É** –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è IoT-—Å–∏—Å—Ç–µ–º —Å —Å–µ—Ä—å—ë–∑–Ω—ã–º–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏.

**‚ö†Ô∏è –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è:**
- –ü—Ä–æ—Ç–æ—Ç–∏–ø–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –æ–±—É—á–µ–Ω–∏—è
- –≠–Ω—Ç—É–∑–∏–∞—Å—Ç–æ–≤ —Å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º –æ–ø—ã—Ç–æ–º
- –ü—Ä–æ–µ–∫—Ç–æ–≤ –≥–¥–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–∞

**‚ùå –ù–ï –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è:**
- –ö–æ–º–º–µ—Ä—á–µ—Å–∫–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–µ–∑ —Å–µ—Ä—å—ë–∑–Ω–æ–π –¥–æ—Ä–∞–±–æ—Ç–∫–∏
- –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã—Ö —Å–∏—Å—Ç–µ–º
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–µ–∑ –æ–ø—ã—Ç–∞ –æ—Ç–ª–∞–¥–∫–∏ ESP32

---

**üîß –ß–µ—Å—Ç–Ω—ã–π —Å–æ–≤–µ—Ç —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞–º:** –ë—É–¥—å—Ç–µ –≥–æ—Ç–æ–≤—ã –ø–æ—Ç—Ä–∞—Ç–∏—Ç—å **60-70% –≤—Ä–µ–º–µ–Ω–∏** –Ω–∞ –±–æ—Ä—å–±—É —Å –ø—Ä–æ–±–ª–µ–º–∞–º–∏ mesh-—Å–µ—Ç–∏ –∏ —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—é —Å–∏—Å—Ç–µ–º—ã. –≠—Ç–æ **–ù–ï –≥–æ—Ç–æ–≤–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞**, –∞ –æ—Å–Ω–æ–≤–∞ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ —Å –º–Ω–æ–∂–µ—Å—Ç–≤–æ–º –ø–æ–¥–≤–æ–¥–Ω—ã—Ö –∫–∞–º–Ω–µ–π.


